<!-- By Chanry © 2018 Chanry All Rights Reserved. 問題回報：chanrytw@gmail.com -->
<!DOCTYPE html>
<html lang="zh_TW">
	<head>
		<meta charset="utf-8"> 			
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

		<script src="https://www.gstatic.com/firebasejs/5.5.8/firebase.js"></script>
		<script>
			var config = {
				apiKey: "AIzaSyDmA4d15qKTrmjJSzELPzYlZ19s-CH73ME",
				authDomain: "yafeng-b69f1.firebaseapp.com",
				databaseURL: "https://yafeng-b69f1.firebaseio.com",
				projectId: "yafeng-b69f1",
				storageBucket: "yafeng-b69f1.appspot.com",
				messagingSenderId: "459564179835"
			};
			firebase.initializeApp(config);
		</script>

		<!-- <script src="./jquery-3.3.1.min.js"></script>	 -->
		<!-- <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script> -->
		<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
		<link href="./css/style.css" rel="stylesheet" type="text/css">
		<link href="./css/animate.css" rel="stylesheet" type="text/css">
		<title>隨機警報鬧鐘</title>

	</head>
	<body class="text-center">

		<div id="app" class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column">
			<header class="mb-auto"></header>
		
			<main role="main" class="inner cover">
				<img class="animated fadeInDown delay-07s" src="/img/alarm.png" alt="">
				<h1 class="animated fadeInDown delay-07s">隨機警報鬧鐘</h1>
				<p class="lead animated fadeInUp delay-1s">
					此頁面開著才能收到警報，縮小視窗也可。<br>
					警報區間為週一至週五09:00~17:00<br>
					（午休12:00~13:00除外）<br>
					每月至多兩個警報，兩警報間隔至少3天。<br>
					現在時間：{{date | formatDate}}<br>
					本月已警報次數：0/2
				</p>
				<p class="lead animated fadeInUp delay-1s">
					<a href="#" class="btn btn-lg btn-secondary">修改設定</a>
				</p>
			</main>
		
			<footer class="mastfoot mt-auto">
				<div class="inner">
				<p>Ver 1.0.1 © 2018 Chanry All Rights Reserved</p>
				</div>
			</footer>
		</div>

		<script type="text/javascript">
			var Explosion1 = "";
			var Explosion2 = "";

			var padDate = function (value) {    //在月份、日期、小時，如小於10補0
				return value<10?'0'+value:value;
			};
			var app = new Vue({
				el:'#app',
				data:{
					date:new Date()
				},
				filters:{   //過濾器
					formatDate:function (value) {   //value為需要過濾的數據
						var date = new Date();
						var year = date.getFullYear();
						var month = padDate(date.getMonth()+1);
						var day = padDate(date.getDate());
						var hours = padDate(date.getHours());
						var minutes = padDate(date.getMinutes());
						var seconds = padDate(date.getSeconds());
						return year+'-'+month+'-'+day+' '+hours+':'+minutes+':'+seconds;
					}
				},
				mounted: function () {  //定時器，每秒更新
					var _this = this;
					this.timer = setInterval(function () {
						_this.date = new Date(); //修改date
						// <<<<<此處待新增>>>>>
					},1000);
				},
				beforeDestory:function () { //清除定時器
					if (this.timer){
						clearInterval(this.timer);  //在關閉前清除定時器
					}
				}
			})
			
			var date = new Date();
			var year = date.getFullYear();
			var month = padDate(date.getMonth()+1);
			var day = padDate(date.getDate());
			var hours = padDate(date.getHours());
			var minutes = padDate(date.getMinutes());

			var db = firebase.firestore();
			db.collection("Yafeng").doc("AlarmTime").get().then(function(doc) {
				if (doc.exists) {
					console.log("最近更新警報時間為", doc.data().UpdateYM);
					// 確認本月是否已有警報
					var date = new Date();
					if (year+month.toString() == doc.data().UpdateYM) {
						console.log("判斷本月已有更新警報");
						// 提取警報12
						Explosion1 = doc.data().Explosion1;
						Explosion2 = doc.data().Explosion2;
					} else {
						console.log("判斷本月沒有更新警報，將進行更新...");
						// 如果本月沒有更新警報
						// 跑亂數得日期+小時+分鐘
						var Explosion = function () {
							var max = new Date(year,month,0).getDate(); //取得本月最後一天
							var min = day; //取得今日日期
							var ExplosionDay = padDate(Math.floor(Math.random()*(max-min+1))+min);

							max = 17;
							min = 9;
							do {
								var ExplosionHours = padDate(Math.floor(Math.random()*(max-min+1))+min);
							} while (ExplosionHours==12);
							
							max = 59;
							min = 0;
							var ExplosionMinutes = padDate(Math.floor(Math.random()*(max-min+1))+min);

							return ExplosionDay.toString()+ExplosionHours.toString()+ExplosionMinutes.toString();
						};
						
						// 如果亂數出來的時間在現在時間之前，則再換
						do {
							Explosion1 = Explosion();
						} while (Explosion1<=day.toString()+hours.toString()+minutes.toString());
						// 至此產出Explosion1

						// 如果本月只剩六天，那就只用一個警報
						if (day>24) {
							Explosion2 = "999999";
						} else {
							// 兩警報間隔3天以上
							do { 
								// 如果亂數出來的時間在現在時間之前，則再換
								do {
									Explosion2 = Explosion();
								} while (Explosion2<=day.toString()+hours.toString()+minutes.toString());
							} while (Math.abs(Number(Explosion1.substr(0,2))-Number(Explosion2.substr(0,2)))<3);
						}
						// 至此產出Explosion2

						// 開始寫入DB
						db.collection("Yafeng").doc("AlarmTime").update({
							UpdateYM: year+month.toString(),
							Explosion1: Explosion1,
							Explosion2: Explosion2
						})
						.then(function() {
							console.log("更新本月警報時間完成!");
						});
					}
				} else {
					console.log("找不到UpdateYM");
				}
			}).catch(function(error) {
				console.log("讀取UpdateYM失敗：", error);
			});


			
		</script>



	</body>
</html>